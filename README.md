# Avito-shop

## Стек:
на стадии разработки: Python 3.9, Django, DRF, SQLite
+ для деплоя: Docker, Gunicorn, nginx, Postgres


## Функционал:
### Для пользователя "Сотрудник"
- авторизация
- просмотр профиля
- подарить монеты
- купить мерч
- просмотреть список мерча

### Для пользователя "Администратор"
- автоматическая загрузка данных (или loaddata)
- панель доступа ко всем данным (при запуске в контейнерах автоматиечски создаётся админ и загружаются данные в мерч) 
- логирование 

## Задачи
- [x] Спроектировать модель данных 
- [x] Создать проект, приложение, настроить среду
- [x] Выбрать модель для профиля (переписать User)
- [x] Продумать ручки
- [x] Создать модели
- [x] Продумать уровень валидации
- [x] Продумать уровень логики
- [x] Разделить настройки на тест и прод среды
- [x] Настроить контейнеризацию 

## Проектирование
- Модель данных ERD
<img src="screens/erdiagram.png" alt="Модель данных ERD" width="600">

- Ручки (дополнительно список всех юзеров для админа)

| url       | method       | что делает      | кто может      |
|:----------|:----------|:---------:|----------:|
| /api/info   | get   | Получить информацию о монетах, инвентаре и истории транзакций.   | Юзер видит только свои данные   |
| /api/sendCoin | post  | Отправить монеты другому пользователю.  | Авторизованный юзер  |
| /api/buy/{item}  | get (Странно, что get, вроде не по REST) | Купить предмет за монеты.  |Авторизованный юзер  |
| /api/auth  | post | Аутентификация и получение JWT-токена. При первой аутентификации пользователь создается автоматически.  |Любой юзер |
| /api/merch  | get | Просмотр всего списка мерча.  |Любой юзер |


## Уровень моделей
Структура данных и связи между ними представлены на уровне моделей (avito_shop/api/models.py). Модели настроены так, чтобы в админке с ними было удобно работать (verbose_name и def __str__(self)). Краткое описание моделей:  
- Profile: username, coins(default=1000)
- Merch: name, price
- Gift: sender, reciever, amount, datetime
- Buy: user, merch, datetime 

## Уровень сериализаторов
Проверка данных на входе и преобразование данных на выходе происходит на уровне сериализаторов (avito_shop/api/serializers.py). Предусмотрены проверки наличия данных, соответствия типам, достаточного количества и других правил (например, нельзя переводить монеты себе).

## Уровень представлений
Логика обработка данных происходит на уровне представления (avito_shop/api/views.py): создание, изменение данных, обработка ошибок, возврат ответа на запрос клиента.

## Настройка деплоя
- Для деплоя используется Docker: avito_shop/Dockerfile + docker-compose.yml
- В docker-compose.yml прописаны контейнеры для БД (postgres_db), бэкенда (avito_backend) и прокси-сервера (nginx_proxy)
- При запуске контейнера бэкенда исполняется файл run.sh, в котором прописаны миграции БД, сбор и копирование стактики, создание админа и загрузка справочника товаров.



# Запуск проекта
Перед запуском проекта в любом режиме необходим создать файл для переменных окружения (.env). В качестве примера используйте .env_example. Для работы с переменными окружения используется библиотека python-dotenv.

## Запуск проекта в режиме разработки 
Склонируйте проект
```bash
git clone git@github.com:belyashnikovatn/Avito-shop.git
```
В терминале выполните команды:
```bash
python -m venv venv
source venv/Scripts/activate
python -m pip install --upgrade pip
pip install -r requirements.txt
cd avito_shop/
python manage.py migrate
python manage.py initadmin
python manage.py loaddata merch.json
python manage.py runserver
```

## Запуск проекта 
убедитесь, что у вас установлен и запущен Docker
В корне проекта выполните команду:
```bash
docker-compose up --build  -d
```
После этого проект будет доступен по адресу http://localhost:8080/

Эндпоинты:
http://localhost:8080/api/merch/
http://localhost:8080/api/auth/
http://localhost:8080/api/info/
http://localhost:8080/api/buy/{item}/
http://localhost:8080/api/sendCoin/
